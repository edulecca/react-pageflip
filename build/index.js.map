{"version":3,"file":"index.js","sources":["../src/html-flip-book/index.tsx"],"sourcesContent":["import React, {\n    ReactElement,\n    useCallback,\n    useEffect,\n    useImperativeHandle,\n    useRef,\n    useState,\n} from 'react';\n\nimport { PageFlip } from 'page-flip';\nimport { IFlipSetting, IEventProps } from './settings';\n\ninterface IProps extends IFlipSetting, IEventProps {\n    className: string;\n    style: React.CSSProperties;\n    children: React.ReactNode;\n    renderOnlyPageLengthChange?: boolean;\n}\n\nconst HTMLFlipBookForward = React.forwardRef(\n    (props: IProps, ref: React.MutableRefObject<PageFlip>) => {\n        const htmlElementRef = useRef<HTMLDivElement>(null);\n        const childRef = useRef<HTMLElement[]>([]);\n        const pageFlip = useRef<PageFlip>();\n\n        const [pages, setPages] = useState<ReactElement[]>([]);\n\n        // Ref-bridge: store callbacks in refs so handlers are never stale\n        const onFlipRef = useRef(props.onFlip);\n        const onChangeOrientationRef = useRef(props.onChangeOrientation);\n        const onChangeStateRef = useRef(props.onChangeState);\n        const onInitRef = useRef(props.onInit);\n        const onUpdateRef = useRef(props.onUpdate);\n\n        useEffect(() => {\n            onFlipRef.current = props.onFlip;\n            onChangeOrientationRef.current = props.onChangeOrientation;\n            onChangeStateRef.current = props.onChangeState;\n            onInitRef.current = props.onInit;\n            onUpdateRef.current = props.onUpdate;\n        });\n\n        // Track whether handlers have been registered\n        const handlersRegistered = useRef(false);\n\n        useImperativeHandle(ref, () => ({\n            pageFlip: () => pageFlip.current,\n        }));\n\n        const refreshOnPageDelete = useCallback(() => {\n            if (pageFlip.current) {\n                pageFlip.current.clear();\n            }\n        }, []);\n\n        useEffect(() => {\n            childRef.current = [];\n\n            if (props.children) {\n                const childList = React.Children.map(props.children, (child) => {\n                    return React.cloneElement(child as ReactElement, {\n                        ref: (dom) => {\n                            if (dom) {\n                                childRef.current.push(dom);\n                            }\n                        },\n                    });\n                });\n\n                if (!props.renderOnlyPageLengthChange || pages.length !== childList.length) {\n                    if (childList.length < pages.length) {\n                        refreshOnPageDelete();\n                    }\n\n                    setPages(childList);\n                }\n            }\n            // eslint-disable-next-line react-hooks/exhaustive-deps\n        }, [props.children]);\n\n        useEffect(() => {\n            if (pages.length > 0 && childRef.current.length > 0) {\n                if (htmlElementRef.current && !pageFlip.current) {\n                    // Patch removeChild to handle nodes that PageFlip reparents\n                    const el = htmlElementRef.current;\n                    const origRemoveChild = el.removeChild.bind(el);\n                    el.removeChild = function <T extends Node>(child: T): T {\n                        if (child.parentNode === el) {\n                            return origRemoveChild(child);\n                        }\n                        if (child.parentNode) {\n                            return child.parentNode.removeChild(child) as T;\n                        }\n                        return child;\n                    };\n\n                    pageFlip.current = new PageFlip(el, props);\n                }\n\n                if (!pageFlip.current.getFlipController()) {\n                    pageFlip.current.loadFromHTML(childRef.current);\n                } else {\n                    pageFlip.current.updateFromHtml(childRef.current);\n                }\n\n                // Register handlers once via ref-bridge (stable, never stale)\n                if (!handlersRegistered.current) {\n                    const flip = pageFlip.current;\n                    flip.on('flip', (e: unknown) => onFlipRef.current?.(e));\n                    flip.on('changeOrientation', (e: unknown) => onChangeOrientationRef.current?.(e));\n                    flip.on('changeState', (e: unknown) => onChangeStateRef.current?.(e));\n                    flip.on('init', (e: unknown) => onInitRef.current?.(e));\n                    flip.on('update', (e: unknown) => onUpdateRef.current?.(e));\n                    handlersRegistered.current = true;\n                }\n            }\n            // eslint-disable-next-line react-hooks/exhaustive-deps\n        }, [pages]);\n\n        // startPage reactivity: navigate when startPage prop changes\n        useEffect(() => {\n            if (pageFlip.current && pageFlip.current.getFlipController()) {\n                const current = pageFlip.current.getCurrentPageIndex();\n                if (props.startPage !== undefined && props.startPage !== current) {\n                    pageFlip.current.turnToPage(props.startPage);\n                }\n            }\n        }, [props.startPage]);\n\n        // Cleanup on unmount\n        useEffect(() => {\n            return () => {\n                if (pageFlip.current) {\n                    try {\n                        pageFlip.current.getRender()?.stop();\n                    } catch (_) {\n                        // ignore if already destroyed\n                    }\n                    pageFlip.current = null;\n                }\n            };\n        }, []);\n\n        return (\n            <div ref={htmlElementRef} className={props.className} style={props.style}>\n                {pages}\n            </div>\n        );\n    }\n);\n\nexport const HTMLFlipBook = React.memo(HTMLFlipBookForward);\n"],"names":["React","useRef","pageFlip","useState","useEffect","useImperativeHandle","useCallback","PageFlip"],"mappings":"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"}